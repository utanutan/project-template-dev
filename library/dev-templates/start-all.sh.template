#!/bin/bash
# =============================================================================
# Service Startup Script Template
# =============================================================================
# Usage: ./scripts/start-all.sh [start|stop|status|restart]
#
# This script manages all project services:
#   - VictoriaLogs (log storage)
#   - Promtail (log forwarding)
#   - Application server
# =============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$SCRIPT_DIR/.."
MONITORING_DIR="$PROJECT_DIR/monitoring"
LOG_DIR="$PROJECT_DIR/logs"

# Ensure logs directory exists
mkdir -p "$LOG_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# =============================================================================
# Service Functions
# =============================================================================

start_victorialogs() {
    if pgrep -f "victoria-logs-prod" > /dev/null; then
        log_warn "VictoriaLogs already running"
        return 0
    fi
    log_info "Starting VictoriaLogs..."
    cd "$MONITORING_DIR"
    nohup ./victoria-logs-prod -storageDataPath=./vlogs-data > "$LOG_DIR/victorialogs.log" 2>&1 &
    sleep 2
    if pgrep -f "victoria-logs-prod" > /dev/null; then
        log_info "VictoriaLogs started (http://localhost:9428)"
    else
        log_error "Failed to start VictoriaLogs"
        return 1
    fi
}

start_promtail() {
    if pgrep -f "promtail-linux-amd64" > /dev/null; then
        log_warn "Promtail already running"
        return 0
    fi
    log_info "Starting Promtail..."
    cd "$MONITORING_DIR"
    nohup ./promtail-linux-amd64 -config.file=promtail-config.yml > "$LOG_DIR/promtail.log" 2>&1 &
    sleep 2
    if pgrep -f "promtail-linux-amd64" > /dev/null; then
        log_info "Promtail started (http://localhost:9080)"
    else
        log_error "Failed to start Promtail"
        return 1
    fi
}

# TODO: Add your application server start function here
# start_app() {
#     if pgrep -f "your-app-process" > /dev/null; then
#         log_warn "App already running"
#         return 0
#     fi
#     log_info "Starting App..."
#     cd "$PROJECT_DIR"
#     nohup your-start-command > "$LOG_DIR/app.log" 2>&1 &
#     sleep 2
#     if pgrep -f "your-app-process" > /dev/null; then
#         log_info "App started (http://localhost:PORT)"
#     else
#         log_error "Failed to start App"
#         return 1
#     fi
# }

stop_all() {
    log_info "Stopping all services..."
    pkill -f "victoria-logs-prod" 2>/dev/null && log_info "Stopped VictoriaLogs" || true
    pkill -f "promtail-linux-amd64" 2>/dev/null && log_info "Stopped Promtail" || true
    # TODO: Add your application stop command
    # pkill -f "your-app-process" 2>/dev/null && log_info "Stopped App" || true
    log_info "All services stopped"
}

show_status() {
    echo ""
    echo "=== Service Status ==="
    echo ""

    if pgrep -f "victoria-logs-prod" > /dev/null; then
        echo -e "VictoriaLogs  : ${GREEN}Running${NC} (http://localhost:9428/select/vmui)"
    else
        echo -e "VictoriaLogs  : ${RED}Stopped${NC}"
    fi

    if pgrep -f "promtail-linux-amd64" > /dev/null; then
        echo -e "Promtail      : ${GREEN}Running${NC} (http://localhost:9080)"
    else
        echo -e "Promtail      : ${RED}Stopped${NC}"
    fi

    # TODO: Add your application status check
    # if pgrep -f "your-app-process" > /dev/null; then
    #     echo -e "App           : ${GREEN}Running${NC} (http://localhost:PORT)"
    # else
    #     echo -e "App           : ${RED}Stopped${NC}"
    # fi

    echo ""
}

start_all() {
    log_info "Starting all services..."
    start_victorialogs
    start_promtail
    # TODO: start_app
    echo ""
    show_status
}

# =============================================================================
# Main
# =============================================================================

case "${1:-start}" in
    start)
        start_all
        ;;
    stop)
        stop_all
        ;;
    restart)
        stop_all
        sleep 2
        start_all
        ;;
    status)
        show_status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
